# Aegis Migration Guide: From fudo-secrets to aegis

This guide covers the complete migration from `fudo-secrets` to `aegis` secrets management.

## Overview

Aegis provides a modern Python-based secrets management system to replace the Nix-heavy `fudo-secrets` approach. The migration will happen in parallel, with both systems running simultaneously until full validation is complete.

## Architecture

The aegis ecosystem consists of three components:

1. **`aegis-tools-system`** (`/net/projects/niten/aegis-tools-system`) - Admin CLI tools for building and managing secrets
2. **`aegis`** (`/net/projects/niten/aegis`) - NixOS modules for on-host decryption
3. **`aegis-secrets`** (`/net/projects/niten/aegis-secrets`) - The secrets repository

### Key Features

- **Two-phase decryption**: Phase 1 uses host master key, Phase 2 uses keys from Phase 1
- **Dry-run mode**: Default enabled for safe migration testing
- **Privacy-preserving manifests**: User secrets use hashed filenames with encrypted manifests
- **Dual-encrypted manifests**: Encrypted for both host and user (user can audit their secrets)

### Key Terminology

**IMPORTANT:** There are two types of SSH keys in play:

1. **Master Key** - Used by Aegis to ENCRYPT secrets for a host
   - The host has the private key at a persistent path (e.g., `/state/master-key/key`)
   - The public key is stored in `nix-entities` or set via `aegis set-master-key`
   - Aegis uses this to encrypt secrets only that host can decrypt

2. **SSH Host Keys** - Used by OpenSSH to identify the server
   - Generated by `aegis build-ssh-host-keys` or imported via `aegis import-ssh-host-keys`
   - Stored encrypted (using the master key) in the aegis-secrets repo
   - Deployed to the host and used by `sshd` for client connections
   - We keep these in the repo so we can generate SSHFP records and known_hosts

## Migration Strategy

### Phase 1: Import Existing Secrets
### Phase 2: Parallel Deployment (Dry-Run)
### Phase 3: Validation & Testing
### Phase 4: Production Cutover
### Phase 5: Cleanup

---

## Phase 1: Import Existing Secrets

### Prerequisites

1. **Secure storage location** with your unencrypted secrets
2. **aegis-secrets repository** initialized
3. **Admin key** in `aegis-secrets/keys/admin.pub`
4. **fudo-entities** repository at `/net/projects/niten/nix-entities`

### Set Master Key (if not in nix-entities)

If your host's master key public isn't in nix-entities, set it manually:

```bash
# On the host, get the public key from the master private key
ssh-keygen -y -f /state/master-key/key
# Output: ssh-ed25519 AAAAC3Nza... comment

# In your aegis-secrets repo
aegis set-master-key lambda --public-key "ssh-ed25519 AAAAC3Nza... lambda-master"
```

### Import SSH Host Keys (for OpenSSH)

These are the keys OpenSSH uses to identify the server (NOT the master key):

```bash
aegis import-ssh-host-keys <hostname> \
  --key /secure/storage/<hostname>.ed25519.key \
  --key /secure/storage/<hostname>.ecdsa.key \
  --key /secure/storage/<hostname>.rsa.key \
  --secrets-path ./aegis-secrets
```

**Example:**
```bash
aegis import-ssh-host-keys lambda \
  --key /secure/lambda.ssh_host_ed25519_key \
  --key /secure/lambda.ssh_host_ecdsa_key
```

**What happens:**
- Auto-detects key type (ed25519, ecdsa, or rsa)
- Validates each private key
- Derives public keys automatically
- Creates `src/hosts/lambda.toml` if it doesn't exist
- Encrypts keys with host master key + admin key
- Stores in `build/hosts/lambda/ssh-host-keys.age`

### Import Nexus Keys

```bash
aegis import-nexus-key <hostname> \
  --file /secure/storage/<hostname>.nexus.hmac \
  --secrets-path ./aegis-secrets \
  --entities-path /net/projects/niten/nix-entities
```

**Example:**
```bash
aegis import-nexus-key lambda \
  --file /secure/lambda.nexus.hmac
```

**Key format expected:** `HmacSHA512:base64encodedkey`

### Import Kerberos Realms

```bash
aegis import-kerberos-realm <REALM> \
  --realm-key /secure/storage/realms/<REALM>/realm.key \
  --principals-dir /secure/storage/realms/<REALM>/principals/ \
  --secrets-path ./aegis-secrets
```

**Example:**
```bash
aegis import-kerberos-realm SEA.FUDO.ORG \
  --realm-key /secure/sea-fudo-org/realm.key \
  --principals-dir /secure/sea-fudo-org/principals/
```

**Structure expected:**
```
/secure/sea-fudo-org/
  realm.key
  principals/
    krbtgt_SEA.FUDO.ORG.key
    host_lambda.sea.fudo.org.key
    ssh_lambda.sea.fudo.org.key
```

### Import Custom Secrets

For service-specific or custom secrets:

```bash
aegis import-secret <hostname> <secret-name> \
  --file /secure/storage/<secret-file> \
  --target /run/service/secret.conf \
  --user myservice \
  --group myservice \
  --mode 0600 \
  --secrets-path ./aegis-secrets \
  --entities-path /net/projects/niten/nix-entities
```

**Example:**
```bash
aegis import-secret lambda postgresql-password \
  --file /secure/lambda-postgres.passwd \
  --target /run/postgresql/password \
  --user postgres \
  --group postgres \
  --mode 0400
```

### Batch Import Script

Create a script to import all secrets at once:

```bash
#!/usr/bin/env bash
set -euo pipefail

SECURE_DIR="/path/to/secure/storage"
SECRETS_REPO="/path/to/aegis-secrets"
ENTITIES="/net/projects/niten/nix-entities"

# Import SSH keys for all hosts
for host in lambda nostromo legatus; do
  echo "Importing SSH keys for $host..."
  aegis import-ssh-key "$host" \
    --key "$SECURE_DIR/ssh/$host.ed25519.key" \
    --key "$SECURE_DIR/ssh/$host.ecdsa.key" \
    --secrets-path "$SECRETS_REPO" \
    --entities-path "$ENTITIES"
done

# Import Nexus keys
for host in lambda nostromo legatus; do
  echo "Importing Nexus key for $host..."
  aegis import-nexus-key "$host" \
    --file "$SECURE_DIR/nexus/$host.hmac" \
    --secrets-path "$SECRETS_REPO" \
    --entities-path "$ENTITIES"
done

# Import Kerberos realms
for realm in SEA.FUDO.ORG FUDO.ORG; do
  echo "Importing Kerberos realm $realm..."
  aegis import-kerberos-realm "$realm" \
    --realm-key "$SECURE_DIR/kerberos/realms/$realm/realm.key" \
    --principals-dir "$SECURE_DIR/kerberos/realms/$realm/principals/" \
    --secrets-path "$SECRETS_REPO"
done

echo "Import complete!"
```

---

## Phase 2: Parallel Deployment (Dry-Run)

### Add Aegis to NixOS Config

In `nixos-config/flake.nix`:

```nix
{
  inputs = {
    # ... existing inputs ...
    
    # NixOS modules for secrets decryption
    aegis = {
      url = "github:fudoniten/aegis";  # or path:/net/projects/niten/aegis
      inputs.nixpkgs.follows = "nixpkgs";
    };
    
    aegis-secrets = {
      url = "path:/path/to/aegis-secrets";
      flake = false;
    };
  };

  outputs = { self, nixpkgs, aegis, aegis-secrets, ... }@inputs: {
    # ... in your host configuration ...
    nixosConfigurations.lambda = nixpkgs.lib.nixosSystem {
      modules = [
        aegis.nixosModules.default  # Import aegis modules
        {
          # Use auto-discovery for simplest setup
          aegis.autoSecrets = {
            enable = true;
            dryRun = true;  # IMPORTANT: Start in dry-run mode!
            buildPath = "${aegis-secrets}/build/hosts/lambda";
            masterKeyPath = "/state/master-key/key";  # Adjust to your setup
            users = [ "alice" "bob" ];  # Users with secrets on this host
            roles = [ ];  # Roles this host has (e.g., "kdc", "dns")
          };
        }
        # ... other modules ...
      ];
    };
  };
}
```

### Define Secrets for Services

For each service that uses secrets, add aegis definitions **alongside** existing fudo-secrets definitions:

**Example: Nexus Service**

```nix
# config/service/nexus.nix
{ config, lib, pkgs, ... }:

let
  hostname = config.instance.hostname;
  hostSecrets = config.fudo.secrets.host-secrets."${hostname}";
  
  # Check if running aegis
  useAegis = config.fudo.aegis.enable or false;
in {
  # Keep existing fudo-secrets definition
  fudo.secrets.host-secrets."${hostname}".nexus-key = {
    source-file = config.fudo.secrets.files.nexus-hmacs."${hostname}";
    target-file = "/run/nexus/client.key";
  };
  
  # Add parallel aegis definition
  fudo.aegis.host-secrets."${hostname}".nexus-key = lib.mkIf useAegis {
    source-file = "${config.fudo.aegis.secrets-repo}/build/hosts/${hostname}/nexus-key.age";
    target-file = "/run/nexus/client.key";
    user = "nexus";
    group = "nexus";
    permissions = "0400";
  };
  
  # Service depends on BOTH targets during transition
  systemd.services.nexus-client = {
    after = [ "fudo-secrets.target" ] ++ lib.optional useAegis "aegis-secrets.target";
    requires = [ "fudo-secrets.target" ] ++ lib.optional useAegis "aegis-secrets.target";
  };
}
```

### Deploy and Observe

```bash
# Build and deploy to test host
nixos-rebuild switch --flake .#lambda

# You should see a prominent warning during build:
# ╔═══════════════════════════════════════════════════════════════════╗
# ║                    AEGIS DRY-RUN MODE ENABLED                     ║
# ╚═══════════════════════════════════════════════════════════════════╝

# After deployment, check systemd services
systemctl status aegis-secrets.target
systemctl list-dependencies aegis-secrets.target

# Check dry-run output directory
ls -la /run/aegis-dry-run/
ls -la /run/aegis-dry-run/users/  # User secrets

# Check logs
journalctl -u 'aegis-*' -n 100
```

**Expected log output:**
```
[AEGIS DRY-RUN] Decrypting nexus-key -> dry-run: /run/aegis-dry-run/nexus-key (would be: /run/aegis/nexus-key)
[AEGIS DRY-RUN] Would set: owner=root:root mode=0400 on /run/aegis/nexus-key
[AEGIS DRY-RUN] Secret nexus-key validated successfully (dry-run mode)
```

### User Secrets with Privacy-Preserving Manifests

User secrets are stored with hashed filenames to prevent information leakage:

```
build/hosts/lambda/users/alice/
  manifest.age          # Encrypted manifest (for host + user)
  secrets/
    a1b2c3d4e5f6.age   # Hashed filename - actual name in manifest
    f7g8h9i0j1k2.age   # Another secret
```

The manifest contains:
```yaml
secrets:
  a1b2c3d4e5f6.age:
    name: GITHUB_TOKEN
    type: env
    created: 2024-01-15T10:30:00Z
  f7g8h9i0j1k2.age:
    name: ssh_config
    type: file
    target: ~/.ssh/config
    created: 2024-01-15T10:30:00Z
```

This is encrypted for both the host (can decrypt during boot) and the user (can audit their own secrets).

---

## Phase 3: Validation & Testing

### Validate Decrypted Secrets

Compare aegis-decrypted secrets with fudo-secrets:

```bash
# On the host
diff /run/aegis/nexus-key /run/nexus/client.key
diff /run/aegis/ssh-keys /run/openssh/private/ssh-keys

# Should be identical!
```

### Test Service Functionality

1. **Ensure services still work** (they're using fudo-secrets)
2. **Manually test with aegis secrets:**
   ```bash
   # Example: Test SSH with aegis keys
   cp /run/aegis/ssh-keys /tmp/test-keys
   # ... test functionality ...
   ```

3. **Check all expected secrets are present:**
   ```bash
   ls -la /run/aegis/
   # Should see: nexus-key, ssh-keys, etc.
   ```

---

## Phase 4: Production Cutover

### Per-Service Migration

Migrate one service at a time for safety:

#### 1. Choose a Non-Critical Service First

Example: Nexus on a test host

#### 2. Switch to Production Mode

```nix
# In host configuration
aegis.autoSecrets = {
  enable = true;
  dryRun = false;  # PRODUCTION MODE!
  buildPath = "${aegis-secrets}/build/hosts/lambda";
  masterKeyPath = "/state/master-key/key";
  users = [ "alice" ];
};
```

Or if using the lower-level `aegis.secrets`:

```nix
aegis.secrets = {
  enable = true;
  dryRun = false;  # PRODUCTION MODE!
  secretsPath = "${aegis-secrets}/build/hosts/lambda";
  masterKeyPath = "/state/master-key/key";
  # ... specific secrets ...
};
```

#### 3. Remove fudo-secrets Definition

```nix
# Comment out or remove fudo-secrets definition
# fudo.secrets.host-secrets."${hostname}".nexus-key = { ... };

# Keep only aegis definition
fudo.aegis.host-secrets."${hostname}".nexus-key = {
  source-file = "${config.fudo.aegis.secrets-repo}/build/hosts/${hostname}/nexus-key.age";
  target-file = "/run/nexus/client.key";
  user = "nexus";
  group = "nexus";
  permissions = "0400";
};
```

#### 4. Deploy and Test

```bash
nixos-rebuild switch --flake .#lambda
systemctl status nexus-client
# Verify service works with aegis secrets!
```

#### 5. Roll Out to All Hosts

Once validated on test host, deploy to all hosts for that service.

### Full Migration Checklist

- [ ] SSH keys migrated and tested
- [ ] Nexus keys migrated and tested
- [ ] Kerberos keytabs migrated and tested
- [ ] Service-specific secrets migrated and tested
- [ ] All hosts updated to `dry-run = false`
- [ ] All `fudo.secrets.host-secrets` definitions removed
- [ ] Services only depend on `aegis-secrets.target`

---

## Phase 5: Cleanup

Once fully migrated and stable:

### 1. Remove fudo-secrets

```nix
# In nixos-config/flake.nix, remove:
# - fudo-secrets input
# - fudo-secrets module imports
```

### 2. Archive Old Secrets

```bash
# DON'T DELETE! Archive for safety
cd /net/projects/niten
mv fudo-secrets fudo-secrets.archive.$(date +%Y%m%d)
```

### 3. Update Documentation

- Update deployment docs to use aegis
- Update secrets rotation procedures
- Document aegis workflow for new services

---

## Troubleshooting

### Decryption Fails

**Error:** `age: error: no identity matched any of the recipients`

**Solution:** Ensure host master key matches between entities and on-host key.

```bash
# On host
cat /path/to/master-key-location  # Check key path from entities

# Verify it can decrypt
age -d -i /path/to/master-key < /run/aegis-secrets/build/hosts/hostname/secret.age
```

### Secrets Not Found

**Error:** Service starts before `aegis-secrets.target`

**Solution:** Add proper systemd dependencies:

```nix
systemd.services.my-service = {
  after = [ "aegis-secrets.target" ];
  requires = [ "aegis-secrets.target" ];
};
```

### Permission Denied

**Error:** Service can't read secret file

**Solution:** Check ownership and permissions in aegis config:

```nix
fudo.aegis.host-secrets."${hostname}".my-secret = {
  user = "my-service-user";
  group = "my-service-group";
  permissions = "0400";  # or "0440" for group-readable
};
```

---

## Quick Reference

### Setup Commands

```bash
# Set host master key (if not in nix-entities)
aegis set-master-key <host> --public-key "ssh-ed25519 AAAA..."

# Initialize a host
aegis init-host <host>
```

### Import Commands

```bash
# SSH host keys for OpenSSH (NOT the master key)
aegis import-ssh-host-keys <host> --key <path> --key <path>

# Nexus keys
aegis import-nexus-key <host> --file <path>

# Kerberos realms
aegis import-kerberos-realm <REALM> --realm-key <path> --principals-dir <path>

# Generic secrets
aegis import-secret <host> <name> --file <path> --target <path> --user <user> --group <group> --mode <mode>
```

### Build Commands

```bash
# Generate new secrets
aegis build                      # Build all
aegis build-ssh-host-keys        # Just OpenSSH host keys
aegis build-nexus-keys           # Just Nexus
aegis build-keytabs              # Just Kerberos
```

### NixOS Configuration

**Auto-discovery (recommended):**
```nix
aegis.autoSecrets = {
  enable = true;
  dryRun = true;  # false for production
  buildPath = "${aegis-secrets}/build/hosts/${hostname}";
  masterKeyPath = "/state/master-key/key";
  users = [ "alice" ];  # Users with secrets
  roles = [ ];          # Special roles (kdc, dns, etc.)
};
```

**Manual configuration:**
```nix
aegis.secrets = {
  enable = true;
  dryRun = true;  # false for production
  secretsPath = "${aegis-secrets}/build/hosts/${hostname}";
  masterKeyPath = "/state/master-key/key";
  
  secrets.my-secret = {
    source = "${aegis-secrets}/build/hosts/${hostname}/my-secret.age";
    target = "/run/service/secret";
    user = "service-user";
    group = "service-group";
    permissions = "0400";
    phase = 1;  # 1 = host key, 2 = role/user key
  };
};
```

---

## Support

For issues or questions:
1. Check logs: `journalctl -u 'aegis-secret-*'`
2. Verify dry-run output: `cat /run/aegis/<secret-name>`
3. Compare with fudo-secrets: `diff /run/aegis/<secret> /run/fudo/<secret>`
